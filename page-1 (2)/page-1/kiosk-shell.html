<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=1080, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Timezone Kiosk - Shell</title>
    <script>
        // CRITICAL: Save original window.print BEFORE kiosk_app.py overrides it
        // The pywebview override converts HTML to plain text, losing all CSS formatting
        // We need the real browser print for styled receipt output
        window.__originalPrint = window.print.bind(window);
    </script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            /* Kiosk security: prevent zooming, text selection, and all touch gestures */
            touch-action: none !important;
            -ms-touch-action: none !important;
            -webkit-touch-callout: none !important;
            -webkit-user-select: none !important;
            -moz-user-select: none !important;
            -ms-user-select: none !important;
            user-select: none !important;
            -webkit-tap-highlight-color: transparent !important;
            -webkit-user-drag: none !important;
        }

        /* ===== PRINT STYLES ===== */
        @media print {
            body * {
                visibility: hidden;
            }

            #printable-area,
            #printable-area * {
                visibility: visible;
            }

            #printable-area {
                position: absolute;
                left: 0;
                top: 0;
                width: 100%;
            }

            /* Hide other global elements */
            .global-video,
            #page-frame,
            #loading-overlay,
            #exit-modal {
                display: none !important;
            }
        }

        /* Prevent image/gif selection and dragging */
        img,
        video,
        gif,
        canvas,
        svg {
            pointer-events: none;
            -webkit-user-drag: none !important;
            user-drag: none !important;
            -webkit-touch-callout: none !important;
        }

        html,
        body {
            width: 1080px;
            height: 1920px;
            overflow: hidden;
            background: #000;
        }

        /* ===== PERSISTENT VIDEO BACKGROUNDS ===== */
        .global-video {
            position: fixed;
            top: 0;
            left: 0;
            width: 1080px;
            height: 1920px;
            object-fit: cover;
            z-index: 1;
            opacity: 0;
            transition: opacity 0.3s ease;
            pointer-events: none;
        }

        .global-video.active {
            opacity: 1;
        }

        /* ===== IFRAME CONTAINER ===== */
        #page-frame {
            position: fixed;
            top: 0;
            left: 0;
            width: 1080px;
            height: 1920px;
            border: none;
            z-index: 10;
            background: transparent;
        }

        /* ===== LOADING OVERLAY ===== */
        #loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 9999;
            transition: opacity 0.5s ease;
        }

        #loading-overlay.hidden {
            opacity: 0;
            pointer-events: none;
        }

        #loading-overlay img {
            width: 300px;
            margin-bottom: 40px;
        }

        #loading-text {
            font-family: 'Nulshock', Arial, sans-serif;
            color: #33fff9;
            font-size: 24px;
            letter-spacing: 3px;
        }
    </style>
</head>

<body>
    <!-- ===== PERSISTENT VIDEO BACKGROUNDS (Never Reload) ===== -->
    <video id="bg-main" class="global-video active" autoplay loop muted playsinline>
        <source src="other-bg.mp4" type="video/mp4">
    </video>
    <video id="bg-ood" class="global-video" autoplay loop muted playsinline>
        <source src="OOD-BACKGROUND.mp4" type="video/mp4">
    </video>
    <video id="bg-ooh" class="global-video" autoplay loop muted playsinline>
        <source src="OOH-BACKGROUND.mp4" type="video/mp4">
    </video>
    <video id="bg-snacks" class="global-video" autoplay loop muted playsinline>
        <source src="free-snacks-bg.mp4" type="video/mp4">
    </video>

    <!-- ===== PAGE IFRAME ===== -->
    <iframe id="page-frame" src="welcome.html"></iframe>

    <!-- ===== LOADING OVERLAY ===== -->
    <div id="loading-overlay">
        <img src="timezone-branding.png" alt="Loading">
        <div id="loading-text">LOADING...</div>
    </div>

    <!-- ===== KIOSK SECURITY: Block right-click, zoom, long-press ===== -->
    <script>
        (function () {
            // Block right-click context menu
            document.addEventListener('contextmenu', function (e) {
                e.preventDefault();
                return false;
            }, true);

            // Block long-press context menu on touch devices
            let longPressTimer = null;
            document.addEventListener('touchstart', function (e) {
                longPressTimer = setTimeout(function () {
                    e.preventDefault();
                }, 500);
            }, { passive: false });

            document.addEventListener('touchend', function () {
                if (longPressTimer) {
                    clearTimeout(longPressTimer);
                    longPressTimer = null;
                }
            });

            document.addEventListener('touchmove', function () {
                if (longPressTimer) {
                    clearTimeout(longPressTimer);
                    longPressTimer = null;
                }
            });

            // Block keyboard shortcuts for zoom
            document.addEventListener('keydown', function (e) {
                // Block Ctrl+Plus, Ctrl+Minus, Ctrl+0 (zoom)
                if ((e.ctrlKey || e.metaKey) && (e.key === '+' || e.key === '-' || e.key === '=' || e.key === '0')) {
                    e.preventDefault();
                    return false;
                }
                // Block F3, F5, F12
                if (e.key === 'F3' || e.key === 'F5' || e.key === 'F12') {
                    e.preventDefault();
                    return false;
                }
            }, true);

            // Block wheel zoom (Ctrl+scroll)
            document.addEventListener('wheel', function (e) {
                if (e.ctrlKey) {
                    e.preventDefault();
                    return false;
                }
            }, { passive: false });

            // Block pinch-to-zoom (gesturestart for Safari/iOS)
            document.addEventListener('gesturestart', function (e) {
                e.preventDefault();
                return false;
            }, { passive: false });

            document.addEventListener('gesturechange', function (e) {
                e.preventDefault();
                return false;
            }, { passive: false });

            document.addEventListener('gestureend', function (e) {
                e.preventDefault();
                return false;
            }, { passive: false });

            // Block multi-touch zoom (2+ fingers)
            document.addEventListener('touchstart', function (e) {
                if (e.touches.length > 1) {
                    e.preventDefault();
                    return false;
                }
            }, { passive: false });

            console.log('[KioskShell] Security: Right-click, zoom, and long-press blocked');
        })();
    </script>

    <!-- ===== PERSISTENT BACKGROUND MUSIC (Never Reload) ===== -->
    <script>
        /**
         * BACKGROUND MUSIC MANAGER (Shell-Level)
         * 
         * The music is managed here in the shell so it:
         * 1. Never gets duplicated when pages change in the iframe
         * 2. Continues playing seamlessly across page navigation
         * 3. Properly ducks when other sounds play in the iframe
         */
        (function () {
            const MUSIC_VOLUME = 0.3; // 30% volume
            const DUCKED_VOLUME = 0.1; // 10% volume when other sounds play
            const MUSIC_SRC = 'bg-music.wav';
            const FADE_DURATION = 150; // ms for volume fade transitions

            let bgAudio = null;
            const activeSounds = new Set();

            // Smooth volume transition
            function fadeVolume(audio, targetVolume, duration = FADE_DURATION) {
                if (!audio) return;
                const startVolume = audio.volume;
                const volumeDiff = targetVolume - startVolume;
                const startTime = performance.now();

                function step(currentTime) {
                    const elapsed = currentTime - startTime;
                    const progress = Math.min(elapsed / duration, 1);
                    const easeProgress = 1 - (1 - progress) * (1 - progress);
                    let newVolume = startVolume + (volumeDiff * easeProgress);
                    newVolume = Math.max(0, Math.min(1, newVolume));
                    audio.volume = newVolume;

                    if (progress < 1) {
                        requestAnimationFrame(step);
                    }
                }

                requestAnimationFrame(step);
            }

            // Initialize background music
            function initBackgroundMusic() {
                if (bgAudio) return; // Already initialized

                bgAudio = document.createElement('audio');
                bgAudio.id = 'shell-background-music';
                bgAudio.loop = true;
                bgAudio.preload = 'auto';
                bgAudio.volume = 0;
                bgAudio.src = MUSIC_SRC;
                bgAudio.style.display = 'none';

                bgAudio.addEventListener('canplaythrough', function onReady() {
                    bgAudio.removeEventListener('canplaythrough', onReady);

                    const playPromise = bgAudio.play();
                    if (playPromise !== undefined) {
                        playPromise.then(() => {
                            fadeVolume(bgAudio, MUSIC_VOLUME, 200);
                            console.log('[KioskShell] Background music started');
                        }).catch(function (error) {
                            console.log('[KioskShell] Autoplay prevented, waiting for interaction');

                            function playOnInteraction() {
                                bgAudio.play().then(function () {
                                    fadeVolume(bgAudio, MUSIC_VOLUME, 200);
                                    document.removeEventListener('click', playOnInteraction);
                                    document.removeEventListener('touchstart', playOnInteraction);
                                    console.log('[KioskShell] Background music started on interaction');
                                }).catch(function (e) {
                                    console.log('[KioskShell] Still cannot play music:', e);
                                });
                            }

                            document.addEventListener('click', playOnInteraction);
                            document.addEventListener('touchstart', playOnInteraction);
                        });
                    }
                }, { once: true });

                document.body.appendChild(bgAudio);
            }

            // Duck music when sounds play in iframe
            function handleIframeSoundStart(element) {
                if (activeSounds.size === 0 && bgAudio) {
                    fadeVolume(bgAudio, DUCKED_VOLUME);
                }
                activeSounds.add(element);
            }

            function handleIframeSoundEnd(element) {
                activeSounds.delete(element);
                if (activeSounds.size === 0 && bgAudio) {
                    fadeVolume(bgAudio, MUSIC_VOLUME);
                }
            }

            // Try to start music (called on any user interaction)
            let musicStarted = false;
            function tryStartMusic() {
                if (musicStarted || !bgAudio) return;

                bgAudio.play().then(function () {
                    fadeVolume(bgAudio, MUSIC_VOLUME, 200);
                    musicStarted = true;
                    console.log('[KioskShell] Background music started');
                }).catch(function (e) {
                    console.log('[KioskShell] Cannot play music:', e);
                });
            }

            // Listen for messages from iframe (ducking AND user interaction)
            window.addEventListener('message', function (event) {
                const data = event.data;
                if (!data || !data.type) return;

                if (data.type === 'duckMusic') {
                    if (data.action === 'start') {
                        handleIframeSoundStart(data.soundId || 'unknown');
                    } else if (data.action === 'end') {
                        handleIframeSoundEnd(data.soundId || 'unknown');
                    }
                }

                // User clicked/touched in iframe - try to start music
                if (data.type === 'userInteraction') {
                    tryStartMusic();
                }
            });

            // Also listen for clicks on the shell itself (loading overlay, etc)
            document.addEventListener('click', tryStartMusic);
            document.addEventListener('touchstart', tryStartMusic);

            // Initialize on ready
            if (document.readyState === 'loading') {
                document.addEventListener('DOMContentLoaded', initBackgroundMusic);
            } else {
                initBackgroundMusic();
            }

            // Expose for debugging
            window.ShellMusic = {
                getAudio: () => bgAudio,
                fadeVolume: fadeVolume,
                duck: () => fadeVolume(bgAudio, DUCKED_VOLUME),
                unduck: () => fadeVolume(bgAudio, MUSIC_VOLUME),
                tryStart: tryStartMusic
            };
        })();
    </script>

    <script>
        /**
         * KIOSK SHELL
         * 
         * This shell provides:
         * 1. Persistent background videos (never reload)
         * 2. Iframe for page content (isolated JS/CSS)
         * 3. Message-based navigation
         * 4. Background switching based on page
         * 5. Persistent background music (never duplicates)
         */

        const KioskShell = {
            currentBg: 'main',
            frame: null,

            // Background mapping for pages
            PAGE_BACKGROUNDS: {
                'screensaver.html': 'ood',
                'screensaver-ood.html': 'ood',
                'free-snacks.html': 'snacks'
                // All other pages use 'main'
            },

            init: function () {
                console.log('[KioskShell] Initializing...');
                this.frame = document.getElementById('page-frame');

                // Listen for messages from iframe
                window.addEventListener('message', this.handleMessage.bind(this));

                // Listen for iframe load
                this.frame.addEventListener('load', () => {
                    console.log('[KioskShell] Page loaded:', this.frame.contentWindow.location.href);
                    this.hideLoading();

                    // Switch background based on loaded page
                    try {
                        const loadedUrl = this.frame.contentWindow.location.href.split('/').pop();
                        const bgType = this.PAGE_BACKGROUNDS[loadedUrl] || 'main';
                        this.switchBackground(bgType);
                        console.log('[KioskShell] Auto-switched background for:', loadedUrl, '->', bgType);
                    } catch (e) {
                        console.log('[KioskShell] Could not auto-switch background:', e.message);
                    }

                    // Inject shell connector into iframe
                    this.injectConnector();
                });

                // Wait for main video to be ready
                const mainVideo = document.getElementById('bg-main');
                if (mainVideo.readyState >= 3) {
                    this.hideLoading();
                } else {
                    mainVideo.addEventListener('canplay', () => this.hideLoading(), { once: true });
                    setTimeout(() => this.hideLoading(), 2000);
                }
            },

            handleMessage: function (event) {
                const data = event.data;
                if (!data || !data.type) return;

                console.log('[KioskShell] Message received:', data);

                switch (data.type) {
                    case 'navigate':
                        this.navigateTo(data.url);
                        break;
                    case 'switchBackground':
                        this.switchBackground(data.background);
                        break;
                }
            },

            // Navigation lock to prevent rapid clicks causing race conditions
            _isNavigating: false,

            navigateTo: function (url) {
                // Prevent rapid navigation
                if (this._isNavigating) {
                    console.log('[KioskShell] Navigation locked, ignoring:', url);
                    return;
                }
                this._isNavigating = true;

                // Clear lock after 2 seconds (safety fallback)
                setTimeout(() => { this._isNavigating = false; }, 2000);

                console.log('[KioskShell] Navigating to:', url);

                // Switch background based on target page
                const bgType = this.PAGE_BACKGROUNDS[url] || 'main';
                this.switchBackground(bgType);

                // Navigate iframe
                this.frame.src = url;
            },

            switchBackground: function (bgType) {
                if (bgType === this.currentBg) return;

                console.log('[KioskShell] Switching background:', this.currentBg, '->', bgType);

                // Hide all backgrounds
                document.querySelectorAll('.global-video').forEach(v => {
                    v.classList.remove('active');
                });

                // Show target background
                const bgMap = {
                    'main': 'bg-main',
                    'ood': 'bg-ood',
                    'ooh': 'bg-ooh',
                    'snacks': 'bg-snacks'
                };

                const targetEl = document.getElementById(bgMap[bgType] || 'bg-main');
                if (targetEl) {
                    targetEl.classList.add('active');
                }

                this.currentBg = bgType;
            },

            hideLoading: function () {
                document.getElementById('loading-overlay').classList.add('hidden');
            },

            injectConnector: function () {
                try {
                    const iframeWindow = this.frame.contentWindow;
                    const iframeDoc = this.frame.contentDocument;

                    // Only inject if we have access (same origin)
                    if (!iframeDoc) return;

                    // Override navigation functions in iframe
                    iframeWindow.shellNavigate = (url) => {
                        window.parent.postMessage({ type: 'navigate', url: url }, '*');
                    };

                    // Override window.location.href setter
                    // This intercepts navigation and sends to shell instead
                    const originalLocation = iframeWindow.location;

                    // Intercept link clicks
                    iframeDoc.addEventListener('click', (e) => {
                        const link = e.target.closest('a');
                        if (link && link.href && link.href.endsWith('.html')) {
                            e.preventDefault();
                            const url = link.href.split('/').pop();
                            window.parent.postMessage({ type: 'navigate', url: url }, '*');
                        }
                    });

                    // Make background transparent
                    const container = iframeDoc.querySelector('.container');
                    if (container) {
                        container.style.background = 'transparent';
                        container.style.backgroundColor = 'transparent';
                    }

                    // Remove video backgrounds from iframe (we have them in shell)
                    const videos = iframeDoc.querySelectorAll('.video-bg, video.hero-background');
                    videos.forEach(v => {
                        v.style.opacity = '0';
                        v.style.display = 'none';
                    });

                    console.log('[KioskShell] Connector injected successfully');

                } catch (e) {
                    console.log('[KioskShell] Cannot inject connector (cross-origin):', e.message);
                }
            }
        };

        // Initialize on DOM ready
        document.addEventListener('DOMContentLoaded', () => {
            KioskShell.init();
        });

        // Expose for debugging
        window.KioskShell = KioskShell;
    </script>

    <!-- ===== SECRET EXIT GESTURE: Tap bottom-right corner 5 times within 3 seconds ===== -->
    <!-- Shows password keypad modal, requires "timezone@shutdown" to exit -->

    <!-- Password Modal HTML -->
    <div id="kiosk-exit-modal"
        style="display:none; position:fixed; top:0; left:0; width:1080px; height:1920px; background:rgba(0,0,0,0.95); z-index:99999; flex-direction:column; align-items:center; justify-content:center;">
        <div style="background:#1a1a2e; border-radius:20px; padding:40px; width:800px; text-align:center;">
            <h2 style="color:#fff; font-size:36px; margin-bottom:20px; font-family:Arial,sans-serif;">üîê Admin Exit</h2>
            <p style="color:#888; font-size:18px; margin-bottom:20px; font-family:Arial,sans-serif;">Enter password to
                shutdown kiosk</p>

            <!-- Password Display -->
            <div id="pwd-display"
                style="background:#0d0d1a; border:2px solid #333; border-radius:10px; padding:20px; margin-bottom:20px; min-height:60px; font-size:32px; color:#4ecdc4; font-family:monospace; letter-spacing:5px;">
            </div>

            <!-- Error Message -->
            <div id="pwd-error"
                style="color:#ff4757; font-size:18px; margin-bottom:15px; height:24px; font-family:Arial,sans-serif;">
            </div>

            <!-- Keypad -->
            <div id="keypad" style="display:grid; grid-template-columns:repeat(6,1fr); gap:8px; margin-bottom:20px;">
            </div>

            <!-- Action Buttons -->
            <div style="display:flex; gap:20px; justify-content:center; margin-top:20px;">
                <button id="pwd-cancel"
                    style="background:#666; color:#fff; border:none; border-radius:10px; padding:20px 60px; font-size:24px; font-family:Arial,sans-serif; cursor:pointer;">Cancel</button>
                <button id="pwd-clear"
                    style="background:#ff4757; color:#fff; border:none; border-radius:10px; padding:20px 40px; font-size:24px; font-family:Arial,sans-serif; cursor:pointer;">Clear</button>
                <button id="pwd-submit"
                    style="background:#4ecdc4; color:#000; border:none; border-radius:10px; padding:20px 60px; font-size:24px; font-family:Arial,sans-serif; cursor:pointer; font-weight:bold;">Shutdown</button>
            </div>
        </div>
    </div>

    <script>
        (function () {
            /**
             * SECRET KIOSK EXIT GESTURE WITH PASSWORD
             * 
             * Two ways to trigger:
             * 1. Press Q key 5 times within 2 seconds (backup for keyboard)
             * 2. Click timezone-branding logo 5 times within 2 seconds (for touch)
             * 
             * Password: timezone@shutdown
             */
            const REQUIRED_TAPS = 5;
            const TIME_WINDOW_MS = 2000; // 2 seconds
            const CORRECT_PASSWORD = 'tizo123';

            let logoClickTimestamps = [];
            let qKeyTimestamps = [];
            let currentPassword = '';

            // Get modal elements
            const modal = document.getElementById('kiosk-exit-modal');
            const pwdDisplay = document.getElementById('pwd-display');
            const pwdError = document.getElementById('pwd-error');
            const keypad = document.getElementById('keypad');
            const cancelBtn = document.getElementById('pwd-cancel');
            const clearBtn = document.getElementById('pwd-clear');
            const submitBtn = document.getElementById('pwd-submit');

            // Create keypad buttons
            const keys = [
                '1', '2', '3', '4', '5', '6',
                '7', '8', '9', '0', '@', '#',
                'q', 'w', 'e', 'r', 't', 'y',
                'u', 'i', 'o', 'p', 'a', 's',
                'd', 'f', 'g', 'h', 'j', 'k',
                'l', 'z', 'x', 'c', 'v', 'b',
                'n', 'm', '_', '-', '.', '‚å´'
            ];

            keys.forEach(key => {
                const btn = document.createElement('button');
                btn.textContent = key;
                btn.style.cssText = 'background:#2d2d44; color:#fff; border:none; border-radius:8px; padding:20px; font-size:24px; font-family:Arial,sans-serif; cursor:pointer;';
                btn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    if (key === '‚å´') {
                        currentPassword = currentPassword.slice(0, -1);
                    } else {
                        currentPassword += key;
                    }
                    updateDisplay();
                });
                btn.addEventListener('touchstart', (e) => e.stopPropagation());
                keypad.appendChild(btn);
            });

            function updateDisplay() {
                pwdDisplay.textContent = '‚Ä¢'.repeat(currentPassword.length);
                pwdError.textContent = '';
            }

            function showModal() {
                currentPassword = '';
                updateDisplay();
                pwdError.textContent = '';
                modal.style.display = 'flex';
            }

            function hideModal() {
                modal.style.display = 'none';
                currentPassword = '';
            }

            function attemptExit() {
                if (currentPassword === CORRECT_PASSWORD) {
                    console.log('[KioskExit] Password correct - triggering exit');
                    if (window.electronAPI && window.electronAPI.exitKiosk) {
                        window.electronAPI.exitKiosk();
                    } else if (window.pywebview && window.pywebview.api && window.pywebview.api.shutdown_kiosk) {
                        console.log('[KioskExit] Using pywebview shutdown_kiosk API');
                        window.pywebview.api.shutdown_kiosk();
                    } else {
                        alert('Exit triggered (browser mode)');
                        hideModal();
                    }
                } else {
                    pwdError.textContent = '‚ùå Incorrect password';
                    currentPassword = '';
                    updateDisplay();
                }
            }

            // Button handlers
            cancelBtn.addEventListener('click', (e) => { e.stopPropagation(); hideModal(); });
            clearBtn.addEventListener('click', (e) => { e.stopPropagation(); currentPassword = ''; updateDisplay(); });
            submitBtn.addEventListener('click', (e) => { e.stopPropagation(); attemptExit(); });

            // Prevent modal clicks from propagating
            modal.addEventListener('click', (e) => e.stopPropagation());
            modal.addEventListener('touchstart', (e) => e.stopPropagation());

            // ============ Q KEY DETECTION ============
            function handleQKey() {
                if (modal.style.display === 'flex') return;

                const now = Date.now();
                qKeyTimestamps.push(now);
                qKeyTimestamps = qKeyTimestamps.filter(t => now - t <= TIME_WINDOW_MS);

                console.log(`[KioskExit] Q key ${qKeyTimestamps.length}/${REQUIRED_TAPS}`);

                if (qKeyTimestamps.length >= REQUIRED_TAPS) {
                    console.log('[KioskExit] Q key exit gesture - showing password modal');
                    qKeyTimestamps = [];
                    showModal();
                }
            }

            document.addEventListener('keydown', function (e) {
                if (e.key === 'q' || e.key === 'Q') {
                    handleQKey();
                }
            }, true);

            // ============ LOGO CLICK DETECTION ============
            function handleLogoClick() {
                if (modal.style.display === 'flex') return;

                const now = Date.now();
                logoClickTimestamps.push(now);
                logoClickTimestamps = logoClickTimestamps.filter(t => now - t <= TIME_WINDOW_MS);

                console.log(`[KioskExit] Logo click ${logoClickTimestamps.length}/${REQUIRED_TAPS}`);

                if (logoClickTimestamps.length >= REQUIRED_TAPS) {
                    console.log('[KioskExit] Logo exit gesture - showing password modal');
                    logoClickTimestamps = [];
                    showModal();
                }
            }

            // Listen for clicks on timezone-branding logos in this document
            document.addEventListener('click', function (e) {
                const target = e.target;
                if (target.tagName === 'IMG' &&
                    (target.classList.contains('timezone-branding') ||
                        target.src.includes('timezone-branding') ||
                        target.classList.contains('timezone-logo'))) {
                    handleLogoClick();
                }
            }, true);

            // Expose showModal for iframe pages to call
            window.showExitModal = showModal;
            window.handleLogoClick = handleLogoClick;

            // ============ IFRAME COMMUNICATION ============
            // Listen for messages from iframe pages
            window.addEventListener('message', function (e) {
                if (e.data === 'KIOSK_EXIT_LOGO_CLICK') {
                    console.log('[KioskExit] Received exit message from iframe - showing modal');
                    showModal();
                }

                // Handle silent print request from iframes
                // Supports object format: { type: 'KIOSK_PRINT_SILENT', content: '<html>...' }
                // Or string format: 'KIOSK_PRINT_SILENT' (fallback)
                const isPrintRequest = e.data === 'KIOSK_PRINT_SILENT' || (e.data && e.data.type === 'KIOSK_PRINT_SILENT');

                if (isPrintRequest) {
                    console.log('[Kiosk] Received print request from iframe');

                    // Inject content if provided
                    if (e.data && e.data.content) {
                        const printableArea = document.getElementById('printable-area');
                        if (printableArea) {
                            printableArea.innerHTML = e.data.content;
                            console.log('[Kiosk] Injected content length:', e.data.content.length);
                        }
                    }

                    // WAIT for rendering before printing
                    setTimeout(() => {
                        if (window.electronAPI && window.electronAPI.print) {
                            window.electronAPI.print();
                        } else if (window.__originalPrint) {
                            // Use the ORIGINAL window.print (saved before kiosk_app.py override)
                            // This triggers proper @media print CSS rendering instead of plain-text conversion
                            console.log('[Kiosk] Using original window.print for styled receipt output');
                            window.__originalPrint();
                        } else {
                            console.log('[Kiosk] Falling back to window.print');
                            window.print();
                        }
                    }, 500);

                    // Clean up after print (optional, but good for memory/security)
                    // Note: Print is async in Electron, so clearing immediately might race.
                    // Ideally we'd wait for a callback, but for now we leave it or clear on next print.
                }
            });

            console.log('[KioskExit] Password-protected exit initialized:');
            console.log('  - Press Q key 5 times in 2 seconds');
            console.log('  - Click timezone logo 5 times in 2 seconds');
        })();
    </script>
    <div id="printable-area"></div>
</body>

</html>