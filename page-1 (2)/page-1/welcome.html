<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Timezone Welcome</title>
  <link rel="stylesheet" href="style.css" />
  <style>
    /* Language Selector Toggle Switch Styles */
    .language-selector-switch {
      position: absolute;
      top: 100px;
      right: 120px;
      z-index: 1000;
    }

    .language-toggle {
      cursor: pointer;
      user-select: none;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      filter: drop-shadow(0 4px 12px rgba(0, 0, 0, 0.15));
    }

    .language-toggle:hover {
      transform: scale(1.05);
      filter: drop-shadow(0 6px 20px rgba(0, 0, 0, 0.2));
    }

    .toggle-container {
      position: relative;
      width: 115px;
      height: 70px;
    }

    .toggle-bg {
      position: absolute;
      width: 100%;
      height: 100%;
      background-color: transparent;
      border-radius: 50px;
      overflow: hidden;
      transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
      border: 2px solid rgba(255, 255, 255);
      backdrop-filter: blur(10px);
    }

    .toggle-slider {
      position: absolute;
      top: 6px;
      left: 6px;
      width: 52px;
      height: 52px;
      background-color: #fff;
      border-radius: 50%;
      transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15), 0 0 0 1px rgba(255, 255, 255, 0.1), inset 0 1px 2px rgba(255, 255, 255, 0.8);
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .toggle-labels {
      position: absolute;
      top: 0;
      left: -40px;
      width: 180%;
      height: 100%;
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 0 8px;
      pointer-events: none;
    }

    .lang-label {
      font-size: 20px;
      font-weight: 700;
      color: #fff;
      transition: all 0.3s ease;
      text-shadow: 0 1px 2px rgba(0, 0, 0, 0.2);
      letter-spacing: 0.5px;
    }

    .lang-label.active {
      color: #fff;
      text-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
    }

    /* English mode (toggle to right) */
    .language-toggle.english .toggle-slider {
      transform: translateX(49px);
    }

    /* Active animation */
    .language-toggle:active {
      transform: scale(0.98);
    }

    .language-toggle:active .toggle-slider {
      transform: scale(0.95) translateX(var(--slider-x, 0px));
    }

    .glow-text {
      position: absolute;
      top: 450px;
    }


    .character-wrapper {
      flex: 1;
      display: flex;
      justify-content: center;
      align-items: center;
      width: 100%;
      position: relative;
      margin-top: 150px;
    }

    .button-wrapper {
      position: relative;
      width: 70%;
      max-width: 300px;
      height: 80px;
      display: flex;
      justify-content: center;
      align-items: center;
      margin-bottom: 10%;
      cursor: pointer;
      transition: transform 0.1s;
      bottom: 100px;
      position: absolute;
    }

    /* End Language Selector Toggle Switch Styles */
  </style>
  <script src="page-transition.js"></script>
</head>

<body>
  <div class="container" style="transition: opacity 0.5s ease; opacity: 1" bis_skin_checked="1">
    <!-- Video Background -->
    <video class="video-bg" autoplay="" loop="" muted="" playsinline="">
      <source src="other-bg.mp4" type="video/mp4" />
    </video>

    <div class="language-selector-switch" bis_skin_checked="1">
      <div class="language-toggle" onclick="toggleLanguageSwitch()">
        <div class="toggle-container">
          <div class="toggle-bg">
            <div class="toggle-slider" id="toggle-slider"></div>
          </div>
          <div class="toggle-labels">
            <span class="lang-label left" id="lang-id">ID</span>
            <span class="lang-label right" id="lang-en">EN</span>
          </div>
        </div>
      </div>
    </div>

    <div class="content" bis_skin_checked="1">
      <img src="timezone-branding.png" alt="Added Image" class="timezone-branding editable added-element"
        data-id="added-1-1765031274303"
        style="position: absolute; top: 50%; left: 49%; z-index: 50; transform: translate(calc(-50% + 5.33337px), calc(-50% - 634.667px)) scale(1.5); width: 300px" />
      <h1 id="main-text" class="glow-text editable" data-id="main-text"
        style="z-index: 9; position: relative; transform: translate(0px, -25.2px) scale(1.6); font-weight: bold">
        ISI SALDOMU<br />DI SINI!
      </h1>

      <div class="character-wrapper editable" data-id="character" style="transform: translate(0px, -40px) scale(2.5)"
        bis_skin_checked="1">
        <img src="cat-character.gif" alt="Character" class="character" />
      </div>

      <div class="button-wrapper editable" data-id="button" onclick="handleStart()"
        style="transform: translate(6px, 21px) scale(1.7) !important" bis_skin_checked="1">
        <img src="button.png" alt="Start Button" class="button-bg" />
        <span id="button-text" class="button-text">MULAI</span>
      </div>
    </div>
  </div>

  <script src="asset-preloader.js"></script>
  <script src="api-config.js"></script>
  <script src="auto-reload.js"></script>
  <script src="session-manager.js"></script>
  <script src="shell-connector.js"></script>
  <script src="language.js"></script>
  <script src="dashboard-api.js"></script>
  <script>
    // Start fresh session ONLY if:
    // 1. Coming from screensaver (fresh start)
    // 2. No existing session
    // 3. User explicitly clicked home/restart button (marked in localStorage)
    const referrer = document.referrer || "";
    const isFromScreensaver = referrer.includes("screensaver");
    const isExplicitRestart = localStorage.getItem("tizo_restart") === "true";
    const existingSession = getSession();

    if (isFromScreensaver || !existingSession || isExplicitRestart) {
      startNewSession(true);
      localStorage.removeItem("tizo_restart"); // Clear restart flag
      console.log("Started fresh session (from screensaver or explicit restart)");

      // Send session_start to dashboard
      if (window.Dashboard && window.Dashboard.sendSessionStart) {
        window.Dashboard.sendSessionStart();
      }
    } else {
      // User navigated back - preserve their session
      setCurrentPage("welcome");
      console.log("Preserved existing session for back navigation");
    }
    const translations = {
      en: {
        main: "TOP-UP<br>HERE!",
        button: "START",
        langLabel: "English",
      },
      id: {
        main: "ISI SALDOMU<br>DI SINI!",
        button: "MULAI",
        langLabel: "Bahasa",
      },
    };

    let currentLang = getCurrentLanguage();

    function toggleLanguageSwitch() {
      const newLang = currentLang === "id" ? "en" : "id";
      setLanguage(newLang);
    }

    function applyLanguage(lang) {
      currentLang = lang;
      const data = translations[lang];

      // Update content
      document.getElementById("main-text").innerHTML = data.main;
      document.getElementById("button-text").textContent = data.button;

      // Update toggle switch appearance
      const toggle = document.querySelector(".language-toggle");
      const idLabel = document.getElementById("lang-id");
      const enLabel = document.getElementById("lang-en");

      if (lang === "en") {
        toggle.classList.add("english");
        idLabel.classList.remove("active");
        enLabel.classList.add("active");
      } else {
        toggle.classList.remove("english");
        idLabel.classList.add("active");
        enLabel.classList.remove("active");
      }
    }

    function setLanguage(lang) {
      saveLanguage(lang);
      applyLanguage(lang);
    }

    function handleStart() {
      if (window.isEditModeActive && window.isEditModeActive()) return;
      PageTransition.navigateTo("welcome2.html");
    }

    // Toggle switch doesn't need outside click handling

    // Initialize edit mode

    // Apply saved language preference
    applyLanguage(currentLang);

    // Idle detection - redirect to screensaver after 10 seconds of inactivity
    let idleTimeout;
    const IDLE_TIME = 15000; // 3 seconds for testing

    function resetIdleTimer(e) {
      // console.log('Resetting idle timer due to:', e?.type);
      clearTimeout(idleTimeout);
      // Only set idle timer if not in edit mode
      if (!window.isEditModeActive || !window.isEditModeActive()) {
        idleTimeout = setTimeout(function () {
          console.log("Idle timeout reached! Redirecting...");
          PageTransition.navigateTo("screensaver.html");
        }, IDLE_TIME);
      }
    }

    // Reset timer on any user activity
    ["mousemove", "mousedown", "keypress", "touchstart", "scroll", "click"].forEach(function (event) {
      document.addEventListener(event, resetIdleTimer, true);
    });

    // Start the idle timer
    resetIdleTimer();

    // Prefetch screensaver data in background so it's ready when navigating
    async function prefetchScreensaverData() {
      try {
        const [oodRes, oohRes, snacksRes] = await Promise.all([
          fetch(getApiUrl("/api/offers?category=OOD")),
          fetch(getApiUrl("/api/offers?category=OOH")),
          fetch(getApiUrl("/api/offers?category=Snacks")),
        ]);

        const cache = {
          timestamp: Date.now(),
          ood: oodRes.ok ? await oodRes.json() : null,
          ooh: oohRes.ok ? await oohRes.json() : null,
          snacks: snacksRes.ok ? await snacksRes.json() : null,
        };

        sessionStorage.setItem("screensaver_cache", JSON.stringify(cache));
        console.log("Screensaver data prefetched and cached");
      } catch (e) {
        console.log("Prefetch failed, screensaver will fetch directly:", e);
      }
    }

    // Start prefetching immediately
    prefetchScreensaverData();

    // Preload assets in background while user is on welcome page
    // This runs silently without blocking the UI
    if (window.AssetPreloader && !window.AssetPreloader.isReady()) {
      console.log("Starting background asset preload...");
      window.AssetPreloader.preloadAll((percent) => {
        console.log("Background preload: " + percent + "%");
      }).then(() => {
        console.log("âœ… Background preload complete - pages will load instantly");
      });
    }
  </script>
</body>

</html>